// Action Cable provides the framework to deal with WebSockets in Rails.
// You can generate new channels where WebSocket features live using the `rails generate channel` command.
//
//= require action_cable
//= require_self
//= require_tree ./channels

(function() {
  this.App || (this.App = {});

  App.cable = ActionCable.createConsumer();

  App.cable.subscriptions.create({ channel: "WaitForMacChannel" }, {
    received(data) {
      switch(data.type) {
        case 'MAC_FOUND': enableRedirectButton(data.url); break;
        case 'CHANGE_WIFI': changeWifiNetwork(data); break;
        case 'WIFI': wifiNetwork(data); break;
      }
    },
    connected() {
      let username = ''
      if (username = document.querySelector('body').dataset.username) {
        let agent_request = '<%= ENV.fetch('AGENT_REQUEST') %>'
        fetch(agent_request + encodeURI(username), {mode: 'no-cors'}).catch(err => console.log(err))
      }
    }
  })
}).call(this);


function enableRedirectButton(url) {
  let content = document.querySelector('#content')
  let btn = document.createElement('button')

  content.innerHTML = '<h2>We found you!</h2>'
  content.appendChild(btn)
  btn.innerHTML = 'Join Game'
  btn.setAttribute('class', 'btn btn-primary')
  btn.addEventListener('click', function () {
    location.href = url
  })
}

function wifiNetwork({ wifis, userCount }) {
  let content = document.querySelector('#content')
  addUserCount(content, userCount)

  content.innerHTML += '<p>Please select your current WIFI Network, so we have a better chance to find you</p>'
  let selectGotoWifi = document.createElement('select')
  selectGotoWifi.setAttribute('class', 'form-control')
  wifis.map((wifiName) => {
    let wifi = document.createElement('option')
    wifi.text = wifiName
    wifi.value = wifiName
    selectGotoWifi.appendChild(wifi)
  })
  content.appendChild(selectGotoWifi)
  selectGotoWifi.addEventListener('change', () => {
    console.log('NOTIFY SERVER')
  })
}

function changeWifiNetwork({ wifis, userCount }) {
  let content = document.querySelector('#content')
  addUserCount(content, userCount)

  content.innerHTML += '<p>In order to find you, we need ask you to change your WIFI network. Please select the network you want to connect to. Than change the network.</p>'
  let selectGotoWifi = document.createElement('select')
  selectGotoWifi.setAttribute('class', 'form-control')
  wifis.map((wifiName) => {
    let wifi = document.createElement('option')
    wifi.text = wifiName
    wifi.value = wifiName
    selectGotoWifi.appendChild(wifi)
  })
  content.appendChild(selectGotoWifi)
  selectGotoWifi.addEventListener('change',() => {
    console.log('NOTIFY SERVER')
  })
}

function addUserCount(content, userCount) {
  content.innerHTML = '<h2>You could be one of ' + userCount + ' Users</h2>'
}
