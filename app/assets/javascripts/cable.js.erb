// Action Cable provides the framework to deal with WebSockets in Rails.
// You can generate new channels where WebSocket features live using the `rails generate channel` command.
//
//= require action_cable
//= require_self
//= require_tree ./channels

(function() {
  this.App || (this.App = {});

  App.cable = ActionCable.createConsumer();

  App.cable.subscriptions.create({ channel: "WaitForMacChannel" }, {
    received(data) {
      switch(data.type) {
        case 'MAC_FOUND': enableRedirectButton(data.url); break;
        case 'CHANGE_WIFI': changeWifiNetwork(data.network); break;
      }
    },
    connected() {
      let username = ''
      if (username = document.querySelector('body').dataset.username) {
        let agent_request = '<%= ENV.fetch('AGENT_REQUEST') %>'
        fetch(agent_request + encodeURI(username), {mode: 'no-cors'}).catch(err => console.log(err))
      }
    }
  })
}).call(this);

function enableRedirectButton(url) {
  let content = document.querySelector('#content')
  let btn = document.createElement('button')

  content.innerHTML = '<h2>We found you!</h2>'
  content.appendChild(btn)
  btn.innerHTML = 'Join Game'
  btn.setAttribute('class', 'btn btn-primary')
  btn.addEventListener('click', function () {
    location.href = url
  })
}
